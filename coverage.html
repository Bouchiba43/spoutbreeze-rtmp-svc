
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>controllers: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">spoutbreeze/controllers/broadcasterController.go (0.0%)</option>
				
				<option value="file1">spoutbreeze/controllers/healthController.go (0.0%)</option>
				
				<option value="file2">spoutbreeze/docs/docs.go (0.0%)</option>
				
				<option value="file3">spoutbreeze/initializers/loadEnvVariables.go (0.0%)</option>
				
				<option value="file4">spoutbreeze/initializers/redis.go (0.0%)</option>
				
				<option value="file5">spoutbreeze/main.go (10.0%)</option>
				
				<option value="file6">spoutbreeze/repositories/redisRepository.go (0.0%)</option>
				
				<option value="file7">spoutbreeze/routes/routes.go (0.0%)</option>
				
				<option value="file8">spoutbreeze/services/broadcasterService.go (0.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">no coverage</span>
				<span class="cov1">low coverage</span>
				<span class="cov2">*</span>
				<span class="cov3">*</span>
				<span class="cov4">*</span>
				<span class="cov5">*</span>
				<span class="cov6">*</span>
				<span class="cov7">*</span>
				<span class="cov8">*</span>
				<span class="cov9">*</span>
				<span class="cov10">high coverage</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package controllers

import (
        "net/http"

        "github.com/gin-gonic/gin"
        "spoutbreeze/models"
        "spoutbreeze/services"
)


// JoinBBB godoc
// @Summary      Join BBB
// @Description  Join a BigBlueButton session
// @Tags         Broadcaster
// @Accept       json
// @Produce      json
// @Param        request body models.BroadcasterRequest true "Broadcaster Request"
// @Success      200 {object} models.BroadcasterResponse
// @Failure      400 {object} models.ErrorResponse
// @Failure      500 {object} models.ErrorResponse
// @Router       /broadcaster/joinBBB [post]
func JoinBBB(c *gin.Context) <span class="cov0" title="0">{
        var request models.BroadcasterRequest

        if err := c.ShouldBindJSON(&amp;request); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
                return
        }</span>

        <span class="cov0" title="0">err := services.ProcessBroadcasterRequest(&amp;request)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{"message": "Broadcasting session started successfully"})</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package controllers

import (
        "net/http"

        "github.com/gin-gonic/gin"
)

type HealthController struct{}

func NewHealthController() *HealthController <span class="cov0" title="0">{
        return &amp;HealthController{}
}</span>

// HealthCheck godoc
// @Summary      Health Check
// @Description  Returns the health status of the application
// @Tags         Health
// @Accept       json
// @Produce      json
// @Success      200 {object} map[string]string
// @Router       /health [get]
func (h *HealthController) HealthCheck(c *gin.Context) <span class="cov0" title="0">{
        c.JSON(http.StatusOK, gin.H{
                "status": "healthy",
        })
}</span>

// ReadinessCheck godoc
// @Summary      Readiness Check
// @Description  Checks if the application is ready to handle traffic
// @Tags         Health
// @Accept       json
// @Produce      json
// @Success      200 {object} map[string]string
// @Router       /readiness [get]
func (h *HealthController) ReadinessCheck(c *gin.Context) <span class="cov0" title="0">{
        // Here, you can add checks for your services like DB connection, etc.
        // For example:
        // - Check DB connection
        // - Check cache
        // - Check other dependencies

        c.JSON(http.StatusOK, gin.H{
                "status": "ready",
        })
}</pre>
		
		<pre class="file" id="file2" style="display: none">// Package docs Code generated by swaggo/swag. DO NOT EDIT
package docs

import "github.com/swaggo/swag"

const docTemplate = `{
    "schemes": {{ marshal .Schemes }},
    "swagger": "2.0",
    "info": {
        "description": "{{escape .Description}}",
        "title": "{{.Title}}",
        "termsOfService": "http://swagger.io/terms/",
        "contact": {
            "name": "API Support",
            "url": "http://www.swagger.io/support",
            "email": "support@swagger.io"
        },
        "license": {
            "name": "Apache 2.0",
            "url": "http://www.apache.org/licenses/LICENSE-2.0.html"
        },
        "version": "{{.Version}}"
    },
    "host": "{{.Host}}",
    "basePath": "{{.BasePath}}",
    "paths": {
        "/broadcaster/joinBBB": {
            "post": {
                "description": "Join a BigBlueButton session",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Broadcaster"
                ],
                "summary": "Join BBB",
                "parameters": [
                    {
                        "description": "Broadcaster Request",
                        "name": "request",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "$ref": "#/definitions/models.BroadcasterRequest"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "$ref": "#/definitions/models.BroadcasterResponse"
                        }
                    },
                    "400": {
                        "description": "Bad Request",
                        "schema": {
                            "$ref": "#/definitions/models.ErrorResponse"
                        }
                    },
                    "500": {
                        "description": "Internal Server Error",
                        "schema": {
                            "$ref": "#/definitions/models.ErrorResponse"
                        }
                    }
                }
            }
        },
        "/health": {
            "get": {
                "description": "Returns the health status of the application",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Health"
                ],
                "summary": "Health Check",
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "type": "object",
                            "additionalProperties": {
                                "type": "string"
                            }
                        }
                    }
                }
            }
        },
        "/readiness": {
            "get": {
                "description": "Checks if the application is ready to handle traffic",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Health"
                ],
                "summary": "Readiness Check",
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "type": "object",
                            "additionalProperties": {
                                "type": "string"
                            }
                        }
                    }
                }
            }
        }
    },
    "definitions": {
        "models.BroadcasterRequest": {
            "type": "object",
            "required": [
                "bbb_health_check_url",
                "bbb_server_url",
                "rtmp_url",
                "stream_key"
            ],
            "properties": {
                "bbb_health_check_url": {
                    "type": "string"
                },
                "bbb_server_url": {
                    "type": "string"
                },
                "rtmp_url": {
                    "type": "string"
                },
                "stream_key": {
                    "type": "string"
                }
            }
        },
        "models.BroadcasterResponse": {
            "type": "object",
            "properties": {
                "message": {
                    "type": "string"
                }
            }
        },
        "models.ErrorResponse": {
            "type": "object",
            "properties": {
                "message": {
                    "type": "string"
                }
            }
        }
    }
}`

// SwaggerInfo holds exported Swagger Info so clients can modify it
var SwaggerInfo = &amp;swag.Spec{
        Version:          "1.0",
        Host:             "",
        BasePath:         "/",
        Schemes:          []string{"http"},
        Title:            "SpoutBreeze API",
        Description:      "This is a sample server for SpoutBreeze.",
        InfoInstanceName: "swagger",
        SwaggerTemplate:  docTemplate,
        LeftDelim:        "{{",
        RightDelim:       "}}",
}

func init() <span class="cov0" title="0">{
        swag.Register(SwaggerInfo.InstanceName(), SwaggerInfo)
}</span>
</pre>
		
		<pre class="file" id="file3" style="display: none">package initializers

import (
        "log"

        "github.com/joho/godotenv"
)

func LoadEnvVariables() <span class="cov0" title="0">{
        err := godotenv.Load()
        if err != nil </span><span class="cov0" title="0">{
                log.Println("Error loading .env file, using environment variables")
        }</span>
}</pre>
		
		<pre class="file" id="file4" style="display: none">package initializers

import (
        "context"
        "os"
        "log"
        "fmt"

        "github.com/redis/go-redis/v9"
)

var RedisClient *redis.Client
var RedisContext = context.Background()

func ConnectToRedis() <span class="cov0" title="0">{
        redisPassword := os.Getenv("REDIS_PASSWORD")
        redisHost := os.Getenv("REDIS_HOST")
        redisPort := os.Getenv("REDIS_PORT")
        if redisPassword == "" </span><span class="cov0" title="0">{
                log.Fatalf("REDIS_PASSWORD environment variable not set")
        }</span>

        <span class="cov0" title="0">if redisHost == "" </span><span class="cov0" title="0">{
                log.Fatalf("REDIS_HOST environment variable not set")
        }</span>

        <span class="cov0" title="0">if redisPort == "" </span><span class="cov0" title="0">{
                log.Fatalf("REDIS_PORT environment variable not set")
        }</span>

        <span class="cov0" title="0">redis_address := fmt.Sprintf("%s:%s",redisHost,redisPort )

        RedisClient = redis.NewClient(&amp;redis.Options{
                Addr:     redis_address, 
                Password: redisPassword,
                DB:       0,
        })

        // Ping Redis to check connection
        _, err := RedisClient.Ping(RedisContext).Result()
        if err != nil </span><span class="cov0" title="0">{
                log.Fatalf("Failed to connect to Redis: %v", err)
        }</span>

        <span class="cov0" title="0">log.Println("Connected to Redis successfully")</span>
}</pre>
		
		<pre class="file" id="file5" style="display: none">package main

import (
        "log"
        "os"
        "spoutbreeze/initializers"
        "spoutbreeze/routes"

        "github.com/gin-gonic/gin"

        _ "spoutbreeze/docs" // This is for Swagger documentation


        swaggerFiles "github.com/swaggo/files"
        ginSwagger "github.com/swaggo/gin-swagger"
)

func init() <span class="cov8" title="1">{
        initializers.LoadEnvVariables()
}</span>

//  @title SpoutBreeze API
//  @version 1.0
//  @description This is a sample server for SpoutBreeze.
//        @termsOfService        http://swagger.io/terms/

//        @contact.name        API Support
//        @contact.url        http://www.swagger.io/support
//        @contact.email        support@swagger.io

//        @license.name        Apache 2.0
//        @license.url        http://www.apache.org/licenses/LICENSE-2.0.html

//        @BasePath        /
//        @Schemes        http

func main() <span class="cov0" title="0">{
        gin.SetMode(gin.ReleaseMode)

        router := routes.SetupRouter()

        router.GET("/swagger/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))

        PORT := os.Getenv("PORT")
        if PORT == "" </span><span class="cov0" title="0">{
                PORT = "1323" // Default port
        }</span>
        <span class="cov0" title="0">err := router.Run(":" + PORT)
        if err != nil </span><span class="cov0" title="0">{
                log.Fatalf("Failed to start server: %v", err)
        }</span>
}</pre>
		
		<pre class="file" id="file6" style="display: none">package repositories

import (
        "spoutbreeze/initializers"
)

func StoreRTMPURL(rtmpURL string) error <span class="cov0" title="0">{
        return initializers.RedisClient.Set(initializers.RedisContext, "rtmp_url", rtmpURL, 0).Err()
}</span>

func StoreStreamKey(streamKEY string) error <span class="cov0" title="0">{
        return initializers.RedisClient.Set(initializers.RedisContext, "twitch_stream_key", streamKEY, 0).Err()
}</pre>
		
		<pre class="file" id="file7" style="display: none">package routes

import (
        "github.com/gin-gonic/gin"
        "spoutbreeze/controllers"
)

func SetupRouter() *gin.Engine <span class="cov0" title="0">{
        router := gin.Default()

        broadcasterGroup := router.Group("/broadcaster")
        </span><span class="cov0" title="0">{
                broadcasterGroup.POST("/joinBBB", controllers.JoinBBB)
        }</span>

        <span class="cov0" title="0">healthController := controllers.NewHealthController()
        router.GET("/health", healthController.HealthCheck)
        router.GET("/readiness", healthController.ReadinessCheck)


        return router</span>
}
</pre>
		
		<pre class="file" id="file8" style="display: none">package services

import (
        "log"
        "testing"
        "time"
        "os"
        "net/http"
        "io"
        "encoding/xml"
        "fmt"


        "github.com/tebeka/selenium"
        "github.com/sheva0914/selenium/chrome"
        "spoutbreeze/models"
        // "spoutbreeze/repositories"
)

func ProcessBroadcasterRequest(request *models.BroadcasterRequest) error <span class="cov0" title="0">{
        // Store RTMP URL and Stream URL in Redis
        // err := repositories.StoreRTMPURL(request.RTMPURL)
        // if err != nil {
        //         return err
        // }
        
        // err = repositories.StoreStreamKey(request.StreamKey)
        // if err != nil {
        //         return err
        // }
        
        // Launch selenium script in the background
        go launchSeleniumScript(request.BBBServerURL,request.BBBHealthCheckURL, request.RTMPURL, request.StreamKey)
        
        return nil
}</span>

func launchSeleniumScript(bbbURL string ,BBBHealthCheckURL string,rtmp_url string, stream_key string) <span class="cov0" title="0">{
        StreamBBBSession(nil, bbbURL, BBBHealthCheckURL, rtmp_url, stream_key)
}</span>

func StreamBBBSession(t *testing.T, BBB_URL string, BBBHealthCheckURL string, rtmp_url string, stream_key string) <span class="cov0" title="0">{

        // Get environment variables for Selenium hub URL
    minikubeIP := os.Getenv("CLUSTER_IP")
    moonPort := os.Getenv("MOON_PORT_4444")
        RedisPassword := os.Getenv("REDIS_PASSWORD")
        // Configure Moon options with environment variables
        moonOptions := map[string]interface{}{
                "enableVideo": false,
                "env": []string{"USER_REDIS_PASSWORD=" + RedisPassword,
                        "RTMP_BASE_URL=" + rtmp_url,
                        "Twitch_KEY=" + stream_key,
                        "BBBHealthCheckURL=" + BBBHealthCheckURL,
        },
        }
        // Configure Chrome options}
        
        chromeCaps := chrome.Capabilities{
                ExcludeSwitches: []string{"enable-automation"},
                Args: []string{
                        "--start-maximized",
                        "--use-fake-ui-for-media-stream",
                        "--use-fake-device-for-media-stream",
                        "--autoplay-policy=no-user-gesture-required",
                        "--audio-output-channels=2",
                },
        }
        
        // Define browser capabilities
        caps := selenium.Capabilities{
                "browserName":    "chrome",
                "browserVersion": "0.0.1.9",
                "moon:options":   moonOptions,
                "goog:chromeOptions": chromeCaps,
        }

    
    // Use default values if environment variables are not set
    if minikubeIP == "" </span><span class="cov0" title="0">{
        log.Println("CLUSTER_IP environment variable not set. Using default:", minikubeIP)
    }</span>
    <span class="cov0" title="0">if moonPort == "" </span><span class="cov0" title="0">{
        log.Println("MOON_PORT_4444 environment variable not set. Using default:", moonPort)
    }</span>
    
    // Construct the Selenium hub URL
    <span class="cov0" title="0">seleniumHubURL := fmt.Sprintf("http://%s:%s/wd/hub", minikubeIP, moonPort)

        // Connect to Moon server
        driver, err := selenium.NewRemote(caps, seleniumHubURL)
        if err != nil </span><span class="cov0" title="0">{
                log.Fatalf("Error starting browser: %v", err)
        }</span>
        <span class="cov0" title="0">defer driver.Quit()

        // err = driver.MaximizeWindow("")
    // if err != nil {
    //     log.Printf("Warning: Failed to maximize window: %v", err)
    //     // Alternative approach if maximize doesn't work
    //     _, err = driver.ExecuteScript("window.resizeTo(screen.width, screen.height);", nil)
    //     if err != nil {
    //         log.Printf("Warning: Failed to resize window with JavaScript: %v", err)
    //     }
    // }
        
        // Navigate to BigBlueButton URL
        err = driver.Get(BBB_URL)
        if err != nil </span><span class="cov0" title="0">{
                log.Fatalf("Failed to navigate to BigBlueButton: %v", err)
        }</span>
        
        // Wait for page load
        <span class="cov0" title="0">time.Sleep(5 * time.Second)
        
        // Handle consent popup if exists
        consentButton, err := driver.FindElement(selenium.ByCSSSelector, "button.ytp-button[aria-label='Accept all']")
        if err == nil </span><span class="cov0" title="0">{
                consentButton.Click()
                time.Sleep(2 * time.Second)
        }</span>
        
        // Click listen only button (bigbluebutton session)
        <span class="cov0" title="0">listenOnlyButton, err := driver.FindElement(selenium.ByCSSSelector, "button[aria-label='Listen only']")
        if err == nil </span><span class="cov0" title="0">{
                listenOnlyButton.Click()
                time.Sleep(2 * time.Second)
        }</span>

        // Find and click the close button on the popup
        <span class="cov0" title="0">closeButton, err := driver.FindElement(selenium.ByCSSSelector, "button[aria-label='Close Session Details']")
        if err != nil </span><span class="cov0" title="0">{
                log.Printf("Warning: Failed to find close button: %v", err)
        }</span> else<span class="cov0" title="0"> {
                _, err = driver.ExecuteScript("arguments[0].click();", []interface{}{closeButton})
                        if err != nil </span><span class="cov0" title="0">{
                                log.Printf("Warning: Failed to click close button with JavaScript: %v", err)
                        }</span>
                <span class="cov0" title="0">time.Sleep(2 * time.Second)</span>
        }

        // Find Users and messages close button
        <span class="cov0" title="0">usersAndMessagesButton, err := driver.FindElement(selenium.ByCSSSelector, "button[aria-label='Users and messages toggle']")
        if err != nil </span><span class="cov0" title="0">{
                log.Printf("Warning: Failed to find Users and messages button: %v", err)
        }</span> else<span class="cov0" title="0"> {
                _, err = driver.ExecuteScript("arguments[0].click();", []interface{}{usersAndMessagesButton})
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("Warning: Failed to click Users and messages button with JavaScript: %v", err)
                }</span>
                <span class="cov0" title="0">time.Sleep(2 * time.Second)</span>
        }

        
        // Wait for the session to end 
        
        <span class="cov0" title="0">sessionID := driver.SessionID()
        if sessionID == "" </span><span class="cov0" title="0">{
                log.Fatalf("Failed to retrieve session ID")
        }</span>
        
        // Create HTTP client
        <span class="cov0" title="0">client := &amp;http.Client{
                Timeout: 10 * time.Second,
        }

        // Function to check if meeting is running
        isMeetingRunning := func() bool </span><span class="cov0" title="0">{
                resp, err := client.Get(BBBHealthCheckURL)
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("Error checking meeting status: %v", err)
                        return false
                }</span>
                <span class="cov0" title="0">defer resp.Body.Close()

                body, err := io.ReadAll(resp.Body)
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("Error reading response body: %v", err)
                        return false
                }</span>

                // Parse XML response
                <span class="cov0" title="0">var response struct {
                        ReturnCode string `xml:"returncode"`
                        Running    string `xml:"running"`
                }
                
                err = xml.Unmarshal(body, &amp;response)
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("Error parsing XML response: %v", err)
                        return false
                }</span>
                
                <span class="cov0" title="0">return response.ReturnCode == "SUCCESS" &amp;&amp; response.Running == "true"</span>
        }

        <span class="cov0" title="0">var meetingWasRunning bool
        // Check session status every 20 seconds
        for </span><span class="cov0" title="0">{
                meetingRunning := isMeetingRunning()
                if meetingRunning != meetingWasRunning </span><span class="cov0" title="0">{
                        if meetingRunning </span><span class="cov0" title="0">{
                                log.Println("Meeting is still running, keeping session alive...")
                        }</span> else<span class="cov0" title="0"> {
                                log.Println("Meeting has ended, terminating session...")
                        }</span>
                        <span class="cov0" title="0">meetingWasRunning = meetingRunning</span>
                }
                <span class="cov0" title="0">time.Sleep(20 * time.Second)</span>
        }
        
}</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
